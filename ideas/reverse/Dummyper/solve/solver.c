#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>

#include "aes.h"

int main()
{
    FILE* fp = fopen("dump", "rb");
    char* mem = (char*) malloc(0x200);
    fread(mem, 1, 0x200, fp);
    fclose(fp);
    
    // find in dump by aeskeyfind
    uint8_t key[32] = {0x38, 0x88, 0x2E, 0xAB, 0xE1, 0x0E, 
        0xF8, 0xFE, 0xB8, 0xD4, 0x96, 0x6F, 0x20, 0x16, 0xB7, 
        0xEE, 0xAC, 0x49, 0x1D, 0x22, 0x81, 0xFC, 0xF6, 0x9F, 
        0xE0, 0x71, 0x41, 0x51, 0x1A, 0xBA, 0x0F, 0xC8};

    // find before key in dump
    uint8_t iv[16] = {0x33, 0x0D, 0x3E, 0xDB, 0x3B, 0xDA, 
        0x5A, 0xCE, 0x2B, 0xB0, 0xE9, 0x42, 0x41, 0x14, 0x68, 0xE4};
    char out[128];

    memcpy(out, mem, 128);

    struct AES_ctx ctx;
    AES_init_ctx(&ctx, key);
    AES_ctx_set_iv(&ctx, iv);
    AES_CBC_decrypt_buffer(&ctx, out, 128);

    puts(out);
}